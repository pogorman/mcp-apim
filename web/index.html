<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Philly Poverty Profiteering</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%94%94%3C/text%3E%3C/svg%3E" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface-raised: #222532;
      --bar: #13151c;
      --border: #2a2d3a;
      --text: #e1e4ed;
      --muted: #8b8fa3;
      --accent: #6c8aff;
      --accent-dim: #3d4f8a;
      --accent-hover: #5a7aff;
      --success: #4ade80;
      --error: #f87171;
      --warning: #facc15;
      --user-bg: #1e2a4a;
      --agent-bg: #1a1d27;
      --font-mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ──────────────────────────────────────── */
    header {
      border-bottom: 1px solid var(--border);
      padding: 0.5rem 1rem 0.5rem 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      background: var(--bar);
      height: 42px;
    }

    header h1 {
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
    }

    header h1 span { color: var(--muted); font-weight: 400; font-size: 0.8rem; margin-left: 0.25rem; }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .model-select {
      padding: 0.3rem 0.5rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.75rem;
      cursor: pointer;
      outline: none;
      font-family: inherit;
      min-width: 120px;
    }

    .model-select:hover { border-color: var(--muted); }
    .model-select:focus { border-color: var(--accent); }

    .status {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--success);
      flex-shrink: 0;
    }

    /* ── Main Layout ─────────────────────────────────── */
    .app-body {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-height: 0;
    }

    /* ── Activity Bar ────────────────────────────────── */
    .activity-bar {
      width: 48px;
      flex-shrink: 0;
      background: var(--bar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding-top: 6px;
      gap: 2px;
      transition: width 0.2s ease;
      overflow: hidden;
    }

    .activity-bar.expanded {
      width: 180px;
    }

    /* ── Nav toggle button ── */
    .nav-toggle {
      width: 100%;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: none;
      color: var(--muted);
      cursor: pointer;
      margin-bottom: 4px;
      flex-shrink: 0;
      border-radius: 6px;
    }
    .nav-toggle:hover { color: var(--text); background: rgba(255,255,255,0.04); }
    .nav-toggle svg { width: 18px; height: 18px; transition: transform 0.2s ease; }
    .activity-bar.expanded .nav-toggle svg { transform: rotate(180deg); }
    .activity-bar.expanded .nav-toggle { justify-content: flex-end; padding-right: 14px; }

    .activity-tab {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      color: var(--muted);
      transition: all 0.15s;
      border: none;
      background: none;
      position: relative;
      white-space: nowrap;
      padding: 0;
    }

    .activity-bar.expanded .activity-tab {
      justify-content: flex-start;
      padding: 0 12px;
      gap: 10px;
    }

    .activity-tab:hover {
      color: var(--text);
      background: rgba(255,255,255,0.04);
    }

    .activity-tab.active {
      color: var(--accent);
      background: rgba(108,138,255,0.1);
    }

    .activity-tab.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 8px;
      bottom: 8px;
      width: 3px;
      background: var(--accent);
      border-radius: 0 2px 2px 0;
    }

    .activity-tab svg {
      width: 22px;
      height: 22px;
      flex-shrink: 0;
    }

    .activity-tab .tab-text {
      font-size: 0.8rem;
      opacity: 0;
      width: 0;
      overflow: hidden;
      transition: opacity 0.15s ease, width 0.2s ease;
    }

    .activity-bar.expanded .activity-tab .tab-text {
      opacity: 1;
      width: auto;
    }

    /* ── Panel Area ───────────────────────────────────── */
    .panel-area {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-width: 0;
    }

    .panel {
      display: none;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    .panel.visible {
      display: flex;
      flex: 1;
    }

    .panel + .panel.visible {
      border-left: 1px solid var(--border);
    }

    /* ── Welcome Screen ──────────────────────────────── */
    .welcome-screen {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(rgba(15,17,23,0.82), rgba(15,17,23,0.88)), url('/images/philly-bg.jpg') center/cover no-repeat;
    }

    .welcome-screen.hidden { display: none; }

    .welcome-inner {
      max-width: 480px;
      text-align: center;
      padding: 2rem;
      color: var(--muted);
    }

    .welcome-inner h2 {
      font-size: 1.15rem;
      color: var(--text);
      margin-bottom: 0.6rem;
      font-weight: 600;
    }

    .welcome-inner p {
      font-size: 0.82rem;
      line-height: 1.55;
      margin-bottom: 1.25rem;
    }

    .welcome-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
    }

    .welcome-btn {
      padding: 0.55rem 1.1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .welcome-btn:hover {
      border-color: var(--accent);
      background: var(--accent-dim);
    }

    .welcome-btn svg {
      width: 16px;
      height: 16px;
    }

    /* ── Panel Headers ───────────────────────────────── */
    .panel-header {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      background: var(--surface);
      height: 38px;
    }

    .panel-header-title {
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }

    .btn-small {
      padding: 0.2rem 0.55rem;
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.7rem;
      transition: all 0.15s;
    }

    .btn-small:hover { color: var(--text); border-color: var(--muted); }

    /* ── Chat Panel ──────────────────────────────────── */
    .chat-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem 0;
      scroll-behavior: smooth;
      background: linear-gradient(rgba(15,17,23,0.85), rgba(15,17,23,0.9)), url('/images/philly-bg.jpg') center/cover no-repeat fixed;
    }

    .chat-scroll::-webkit-scrollbar { width: 5px; }
    .chat-scroll::-webkit-scrollbar-track { background: transparent; }
    .chat-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .chat-welcome {
      padding: 2rem 1.25rem;
      text-align: center;
      color: var(--muted);
    }

    .chat-welcome h3 {
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .chat-welcome p {
      font-size: 0.8rem;
      line-height: 1.55;
      margin-bottom: 1rem;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .suggestions {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      text-align: left;
      max-width: 500px;
      margin: 0 auto;
    }

    .suggestion {
      padding: 0.5rem 0.75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 7px;
      cursor: pointer;
      font-size: 0.78rem;
      color: var(--text);
      transition: all 0.15s;
    }

    .suggestion:hover {
      border-color: var(--accent);
      background: var(--accent-dim);
    }

    .message {
      padding: 0.6rem 1rem;
    }

    .message + .message { margin-top: 0.15rem; }

    .msg-user {
      background: var(--user-bg);
      border-radius: 10px;
      margin-left: 2.5rem;
      margin-right: 0.75rem;
    }

    .msg-assistant {
      margin-left: 0.75rem;
      margin-right: 2.5rem;
    }

    .msg-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-bottom: 0.3rem;
      font-weight: 600;
    }

    .msg-content {
      font-size: 0.85rem;
      line-height: 1.6;
      word-break: break-word;
    }

    .msg-content p { margin: 0 0 0.5em; }
    .msg-content p:last-child { margin-bottom: 0; }

    .msg-content .md-h {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--accent);
      margin: 0.8em 0 0.3em;
    }
    .msg-content .md-h:first-child { margin-top: 0; }

    .msg-content .md-list {
      margin: 0.3em 0 0.5em 1.2em;
      padding: 0;
    }
    .msg-content .md-list li {
      margin-bottom: 0.2em;
    }

    .msg-content .md-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5em 0;
      font-size: 0.8rem;
    }
    .msg-content .md-table th,
    .msg-content .md-table td {
      padding: 0.35em 0.6em;
      border: 1px solid var(--border);
      text-align: left;
    }
    .msg-content .md-table th {
      background: rgba(255,255,255,0.05);
      font-weight: 600;
      color: var(--accent);
    }
    .msg-content .md-table tr:nth-child(even) td {
      background: rgba(255,255,255,0.02);
    }

    .msg-content .md-code {
      background: var(--bar);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.6em 0.8em;
      margin: 0.4em 0;
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: 0.78rem;
      overflow-x: auto;
      white-space: pre;
    }

    .msg-content .md-inline-code {
      background: var(--bar);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 0.1em 0.35em;
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: 0.8em;
    }

    .msg-content .md-hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 0.6em 0;
    }

    .msg-tools {
      margin-top: 0.4rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .tool-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.45rem;
      background: var(--accent-dim);
      border-radius: 4px;
      font-size: 0.65rem;
      font-family: var(--font-mono);
      color: var(--accent);
    }

    .tool-badge::before {
      content: '';
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--accent);
    }

    /* Thinking indicator */
    .thinking {
      padding: 0.6rem 1rem;
      margin-left: 0.75rem;
    }

    .thinking-inner {
      display: flex;
      align-items: center;
    }

    .thinking-dots {
      display: flex;
      gap: 3px;
      align-items: center;
    }

    .thinking-dots span {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--muted);
      animation: pulse 1.4s ease-in-out infinite;
    }

    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    .thinking-label {
      font-size: 0.72rem;
      color: var(--muted);
      margin-left: 0.5rem;
    }

    @keyframes pulse {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }

    .error-toast {
      margin: 0.4rem 0.75rem;
      padding: 0.5rem 0.75rem;
      background: #2d1515;
      border: 1px solid #5c2020;
      border-radius: 7px;
      color: var(--error);
      font-size: 0.78rem;
    }

    /* Chat input */
    .chat-input-area {
      border-top: 1px solid var(--border);
      padding: 0.6rem 0.75rem;
      flex-shrink: 0;
    }

    .chat-input-row {
      display: flex;
      gap: 0.6rem;
      align-items: flex-end;
    }

    .chat-input-wrap {
      flex: 1;
      position: relative;
    }

    .chat-input-wrap textarea {
      width: 100%;
      padding: 0.55rem 0.75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.85rem;
      font-family: inherit;
      resize: none;
      min-height: 40px;
      max-height: 140px;
      line-height: 1.4;
      overflow-y: auto;
    }

    .chat-input-wrap textarea:focus { outline: none; border-color: var(--accent); }
    .chat-input-wrap textarea::placeholder { color: var(--muted); }

    .btn-send {
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      transition: background 0.15s;
      white-space: nowrap;
      height: 40px;
    }

    .btn-send:hover { background: var(--accent-hover); }
    .btn-send:disabled { opacity: 0.4; cursor: not-allowed; }

    .chat-input-hint {
      font-size: 0.65rem;
      color: var(--muted);
      text-align: center;
      margin-top: 0.25rem;
    }

    /* ── Tools Panel ─────────────────────────────────── */
    .tools-connect {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .connect-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .connect-row input {
      flex: 1;
      padding: 0.45rem 0.65rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.78rem;
      font-family: var(--font-mono);
    }

    .connect-row input:focus { outline: none; border-color: var(--accent); }

    .btn-connect {
      padding: 0.45rem 0.85rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.78rem;
      font-weight: 500;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .btn-connect:hover { background: var(--accent-hover); }
    .btn-connect:disabled { opacity: 0.4; cursor: not-allowed; }

    .connect-status {
      font-size: 0.7rem;
      margin-top: 0.35rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .connect-status.connected { color: var(--success); }
    .connect-status.disconnected { color: var(--muted); }
    .connect-status.error { color: var(--error); }

    .tools-body {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-height: 0;
    }

    /* Tool list */
    .tool-list {
      width: 220px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      overflow-y: auto;
      background: var(--bg);
    }

    .tool-list::-webkit-scrollbar { width: 4px; }
    .tool-list::-webkit-scrollbar-track { background: transparent; }
    .tool-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .tool-list-header {
      padding: 0.5rem 0.65rem;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }

    .tool-list-item {
      padding: 0.45rem 0.65rem;
      cursor: pointer;
      font-size: 0.78rem;
      border-bottom: 1px solid rgba(42,45,58,0.5);
      transition: all 0.1s;
      color: var(--text);
    }

    .tool-list-item:hover {
      background: var(--surface);
    }

    .tool-list-item.active {
      background: var(--accent-dim);
      color: var(--accent);
      font-weight: 500;
    }

    .tool-list-item .tool-desc {
      font-size: 0.68rem;
      color: var(--muted);
      margin-top: 0.15rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tool-list-empty {
      padding: 1.5rem 0.75rem;
      text-align: center;
      color: var(--muted);
      font-size: 0.78rem;
    }

    /* Tool detail */
    .tool-detail {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
      min-width: 0;
    }

    .tool-detail::-webkit-scrollbar { width: 4px; }
    .tool-detail::-webkit-scrollbar-track { background: transparent; }
    .tool-detail::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .tool-detail-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted);
      font-size: 0.82rem;
    }

    .tool-name {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-family: var(--font-mono);
    }

    .tool-full-desc {
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.5;
      margin-bottom: 0.85rem;
    }

    .param-group {
      margin-bottom: 0.6rem;
    }

    .param-label {
      font-size: 0.72rem;
      font-weight: 600;
      margin-bottom: 0.2rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .param-label code {
      font-family: var(--font-mono);
      color: var(--accent);
    }

    .param-required {
      font-size: 0.6rem;
      color: var(--error);
      font-weight: 400;
    }

    .param-optional {
      font-size: 0.6rem;
      color: var(--muted);
      font-weight: 400;
    }

    .param-desc {
      font-size: 0.68rem;
      color: var(--muted);
      margin-bottom: 0.2rem;
    }

    .param-input {
      width: 100%;
      padding: 0.4rem 0.6rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text);
      font-size: 0.78rem;
      font-family: var(--font-mono);
    }

    .param-input:focus { outline: none; border-color: var(--accent); }

    .tool-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.85rem;
      margin-bottom: 0.75rem;
    }

    .btn-call {
      padding: 0.45rem 1rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.78rem;
      font-weight: 500;
      transition: all 0.15s;
    }

    .btn-call:hover { background: var(--accent-hover); }
    .btn-call:disabled { opacity: 0.4; cursor: not-allowed; }

    .call-timer {
      font-size: 0.72rem;
      font-family: var(--font-mono);
      color: var(--muted);
    }

    .call-timer.active { color: var(--warning); }

    .tool-result-area {
      margin-top: 0.5rem;
    }

    .tool-result-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    .tool-result {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.6rem;
      font-family: var(--font-mono);
      font-size: 0.72rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 400px;
      overflow-y: auto;
      color: var(--text);
    }

    .tool-result::-webkit-scrollbar { width: 4px; }
    .tool-result::-webkit-scrollbar-track { background: transparent; }
    .tool-result::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .tool-result.error {
      border-color: #5c2020;
      color: var(--error);
    }

    /* ── City Portal Panel ───────────────────────────── */
    .city-panel {
      background: #f5f5f5;
      color: #1a1a2e;
      position: relative;
    }

    .city-header-bar {
      background: #004785;
      color: #fff;
      padding: 1.25rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }

    .city-seal {
      width: 48px;
      height: 48px;
      flex-shrink: 0;
    }

    .city-header-text h2 {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      margin-bottom: 0.15rem;
    }

    .city-header-text p {
      font-size: 0.78rem;
      opacity: 0.85;
      font-weight: 400;
    }

    .city-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .city-content::-webkit-scrollbar { width: 5px; }
    .city-content::-webkit-scrollbar-track { background: transparent; }
    .city-content::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

    .city-intro {
      max-width: 700px;
      margin: 0 auto 1.5rem;
      font-size: 0.88rem;
      line-height: 1.65;
      color: #333;
    }

    .city-intro h3 {
      font-size: 1.05rem;
      font-weight: 700;
      color: #004785;
      margin-bottom: 0.5rem;
    }

    .city-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      max-width: 700px;
      margin: 0 auto 1.5rem;
    }

    .city-stat-card {
      background: #fff;
      border-radius: 10px;
      padding: 1.25rem;
      text-align: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      border: 1px solid #e2e2e2;
    }

    .city-stat-value {
      font-size: 1.6rem;
      font-weight: 800;
      color: #004785;
      margin-bottom: 0.2rem;
    }

    .city-stat-label {
      font-size: 0.78rem;
      color: #666;
      font-weight: 500;
    }

    .city-about {
      max-width: 700px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      padding: 1.25rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      border: 1px solid #e2e2e2;
      font-size: 0.82rem;
      line-height: 1.6;
      color: #444;
    }

    .city-about h4 {
      font-size: 0.88rem;
      font-weight: 700;
      color: #004785;
      margin-bottom: 0.4rem;
    }

    /* FAB (floating action button) */
    .chat-fab {
      position: absolute;
      bottom: 1.25rem;
      right: 1.25rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #004785;
      color: #fff;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 14px rgba(0,71,133,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
      z-index: 10;
    }

    .chat-fab:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 20px rgba(0,71,133,0.45);
    }

    .chat-fab svg { width: 24px; height: 24px; }

    /* Chat widget overlay */
    .chat-widget {
      position: absolute;
      bottom: 5.5rem;
      right: 1.25rem;
      width: 400px;
      height: 500px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.18);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 20;
      border: 1px solid #d4d4d4;
    }

    .chat-widget.open {
      display: flex;
    }

    .widget-header {
      background: #004785;
      color: #fff;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .widget-header-title {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .widget-header-sub {
      font-size: 0.65rem;
      opacity: 0.8;
    }

    .widget-close {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.2rem;
      opacity: 0.8;
      transition: opacity 0.15s;
    }

    .widget-close:hover { opacity: 1; }

    .widget-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: #fafafa;
    }

    .widget-messages::-webkit-scrollbar { width: 4px; }
    .widget-messages::-webkit-scrollbar-track { background: transparent; }
    .widget-messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }

    .widget-bubble {
      max-width: 85%;
      padding: 0.55rem 0.75rem;
      border-radius: 12px;
      font-size: 0.82rem;
      line-height: 1.5;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .widget-bubble p { margin-bottom: 0.4em; }
    .widget-bubble p:last-child { margin-bottom: 0; }

    .widget-bubble.user {
      background: #004785;
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .widget-bubble.assistant {
      background: #e8ecf0;
      color: #1a1a2e;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .widget-bubble.system {
      background: transparent;
      color: #888;
      align-self: center;
      font-size: 0.75rem;
      text-align: center;
      padding: 0.3rem;
    }

    .widget-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-top: 0.35rem;
    }

    .widget-tool-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      padding: 0.1rem 0.4rem;
      background: rgba(0,71,133,0.1);
      border-radius: 3px;
      font-size: 0.62rem;
      font-family: var(--font-mono);
      color: #004785;
    }

    .widget-tool-badge::before {
      content: '';
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #004785;
    }

    .widget-thinking {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      align-self: flex-start;
      padding: 0.4rem 0.6rem;
    }

    .widget-thinking-dots {
      display: flex;
      gap: 3px;
    }

    .widget-thinking-dots span {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #888;
      animation: pulse 1.4s ease-in-out infinite;
    }

    .widget-thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .widget-thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    .widget-thinking-label {
      font-size: 0.72rem;
      color: #888;
    }

    .widget-input-area {
      border-top: 1px solid #e2e2e2;
      padding: 0.5rem;
      flex-shrink: 0;
      display: flex;
      gap: 0.5rem;
      background: #fff;
    }

    .widget-input-area input {
      flex: 1;
      padding: 0.5rem 0.7rem;
      border: 1px solid #d4d4d4;
      border-radius: 20px;
      font-size: 0.82rem;
      font-family: inherit;
      color: #1a1a2e;
      outline: none;
    }

    .widget-input-area input:focus { border-color: #004785; }
    .widget-input-area input::placeholder { color: #999; }

    .widget-send {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #004785;
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
      flex-shrink: 0;
    }

    .widget-send:hover { background: #003566; }
    .widget-send:disabled { opacity: 0.4; cursor: not-allowed; }

    .widget-send svg { width: 16px; height: 16px; }

    @media (max-width: 768px) {
      .chat-widget {
        width: calc(100vw - 80px);
        height: 60vh;
        right: 0.5rem;
        bottom: 4.5rem;
      }
    }

    /* ── Copilot Studio Panel ─────────────────────────── */
    .copilot-panel {
      background: #f0f0f8;
      color: #1a1a2e;
      position: relative;
    }

    .copilot-header-bar {
      background: linear-gradient(135deg, #7b2ff7, #2b88d8);
      color: #fff;
      padding: 1.25rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }

    .copilot-header-bar svg {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
    }

    .copilot-header-text h2 {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      margin-bottom: 0.15rem;
    }

    .copilot-header-text p {
      font-size: 0.78rem;
      opacity: 0.85;
      font-weight: 400;
    }

    .copilot-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .copilot-content::-webkit-scrollbar { width: 5px; }
    .copilot-content::-webkit-scrollbar-track { background: transparent; }
    .copilot-content::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

    .copilot-intro {
      max-width: 700px;
      margin: 0 auto 1.5rem;
      font-size: 0.88rem;
      line-height: 1.65;
      color: #333;
    }

    .copilot-intro h3 {
      font-size: 1.05rem;
      font-weight: 700;
      color: #5b2bb5;
      margin-bottom: 0.5rem;
    }

    .copilot-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      max-width: 700px;
      margin: 0 auto 1.5rem;
    }

    .copilot-feature-card {
      background: #fff;
      border-radius: 10px;
      padding: 1.25rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      border: 1px solid #e2e2e2;
    }

    .copilot-feature-card h4 {
      font-size: 0.85rem;
      font-weight: 700;
      color: #5b2bb5;
      margin-bottom: 0.35rem;
    }

    .copilot-feature-card p {
      font-size: 0.78rem;
      color: #555;
      line-height: 1.5;
    }

    .copilot-about {
      max-width: 700px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      padding: 1.25rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      border: 1px solid #e2e2e2;
      font-size: 0.82rem;
      line-height: 1.6;
      color: #444;
    }

    .copilot-about h4 {
      font-size: 0.88rem;
      font-weight: 700;
      color: #5b2bb5;
      margin-bottom: 0.4rem;
    }

    /* Copilot FAB (floating action button — inside panel only) */
    .copilot-fab {
      position: absolute;
      bottom: 1.25rem;
      right: 1.25rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7b2ff7, #2b88d8);
      color: #fff;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(123,47,247,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .copilot-fab:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 24px rgba(123,47,247,0.5);
    }
    .copilot-fab svg { width: 24px; height: 24px; }

    .copilot-widget {
      position: absolute;
      bottom: 5.5rem;
      right: 1.25rem;
      width: 420px;
      height: 500px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 20;
      display: none;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #d4d4d4;
    }
    .copilot-widget.open {
      display: flex;
    }

    .copilot-widget-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 0.8rem;
      background: linear-gradient(135deg, #7b2ff7, #2b88d8);
      color: #fff;
      font-size: 0.82rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    .copilot-widget-header button {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 1.1rem;
      opacity: 0.8;
      padding: 0;
    }
    .copilot-widget-header button:hover { opacity: 1; }

    .copilot-widget iframe {
      flex: 1;
      border: none;
      width: 100%;
    }

    @media (max-width: 768px) {
      .copilot-widget {
        width: calc(100vw - 80px);
        height: 60vh;
        right: 0.5rem;
        bottom: 4.5rem;
      }
    }

    /* ── Maps ────────────────────────────────────────── */
    .welcome-map {
      width: 100%;
      max-width: 600px;
      height: 280px;
      border-radius: 12px;
      margin: 0 auto 1.25rem;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .chat-map-container {
      margin: 0.4rem 0.75rem 0.3rem 0.75rem;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .chat-map-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.3rem 0.6rem;
      background: var(--surface);
      cursor: pointer;
      user-select: none;
    }

    .chat-map-header:hover { background: var(--surface-raised); }

    .chat-map-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .chat-map-title svg { width: 14px; height: 14px; }

    .chat-map-toggle {
      font-size: 0.65rem;
      color: var(--muted);
    }

    .chat-map {
      height: 260px;
      width: 100%;
      transition: height 0.2s;
    }

    .chat-map.collapsed {
      height: 0;
      overflow: hidden;
    }

    /* Fix Leaflet tiles in dark theme */
    .leaflet-tile-pane { filter: none; }
    .leaflet-popup-content-wrapper {
      background: var(--surface) !important;
      color: var(--text) !important;
      border-radius: 8px !important;
      box-shadow: 0 3px 14px rgba(0,0,0,0.4) !important;
    }
    .leaflet-popup-tip { background: var(--surface) !important; }
    .leaflet-popup-content { font-size: 0.75rem !important; line-height: 1.5 !important; }
    .leaflet-popup-content strong { color: var(--accent); }

    /* City panel maps use light popups */
    .city-panel .leaflet-popup-content-wrapper {
      background: #fff !important;
      color: #1a1a2e !important;
    }
    .city-panel .leaflet-popup-tip { background: #fff !important; }
    .city-panel .leaflet-popup-content strong { color: #004785; }

    /* ── User Info ─────────────────────────────────────── */
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.72rem;
      color: var(--muted);
      border-left: 1px solid var(--border);
      padding-left: 0.75rem;
    }

    .user-email {
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btn-logout {
      padding: 0.2rem 0.5rem;
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.65rem;
      transition: all 0.15s;
      white-space: nowrap;
      font-family: inherit;
    }

    .btn-logout:hover {
      color: var(--error);
      border-color: var(--error);
    }

    /* ── About Panel ────────────────────────────────────── */
    .about-body {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }

    .about-content {
      max-width: 820px;
      margin: 0 auto;
    }

    .about-content h2 {
      font-size: 1.3rem;
      margin-bottom: 0.75rem;
      color: var(--text);
    }

    .about-content > p {
      color: var(--muted);
      line-height: 1.7;
      margin-bottom: 1rem;
      font-size: 0.88rem;
    }

    .about-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .about-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
    }

    .about-card-icon {
      width: 32px;
      height: 32px;
      margin-bottom: 0.5rem;
    }

    .about-card-icon svg {
      width: 32px;
      height: 32px;
      color: var(--accent);
    }

    .about-card h3 {
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }

    .about-card-pattern {
      font-size: 0.72rem;
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .about-card p {
      color: var(--muted);
      font-size: 0.82rem;
      line-height: 1.6;
      margin-top: 0.5rem;
    }

    .about-footer {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .about-footer h3 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .about-footer p {
      color: var(--muted);
      font-size: 0.85rem;
      line-height: 1.7;
    }

    /* ── SK Agent Panel ─────────────────────────────────── */
    .sk-agents-row {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .sk-agent-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      padding: 0.12rem 0.4rem;
      background: rgba(139,92,246,0.15);
      border: 1px solid rgba(139,92,246,0.3);
      border-radius: 4px;
      font-size: 0.65rem;
      font-family: 'Cascadia Code', monospace;
      color: #a78bfa;
    }

    .sk-agent-arrow {
      color: var(--border);
      font-size: 0.7rem;
    }

    .sk-time {
      font-size: 0.65rem;
      color: var(--muted);
      margin-top: 0.3rem;
    }

    .thinking-timer {
      font-size: 0.65rem;
      color: var(--muted);
      margin-left: 0.5rem;
      font-variant-numeric: tabular-nums;
    }

    .thinking-phases {
      font-size: 0.65rem;
      color: var(--muted);
      margin-top: 0.3rem;
      margin-left: 1.7rem;
      opacity: 0.8;
    }

    /* ── Docs Panel ─────────────────────────────────────── */
    .docs-body {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-height: 0;
    }

    .doc-list {
      width: 220px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      overflow-y: auto;
      background: var(--bg);
    }

    .doc-list::-webkit-scrollbar { width: 4px; }
    .doc-list::-webkit-scrollbar-track { background: transparent; }
    .doc-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .doc-list-header {
      padding: 0.5rem 0.65rem;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 1;
    }

    .doc-list-item {
      padding: 0.45rem 0.65rem;
      cursor: pointer;
      font-size: 0.78rem;
      border-bottom: 1px solid rgba(42,45,58,0.5);
      transition: all 0.1s;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .doc-list-item:hover { background: var(--surface); }

    .doc-list-item.active {
      background: var(--accent-dim);
      color: var(--accent);
      font-weight: 500;
    }

    .doc-list-item .doc-icon {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      opacity: 0.6;
    }

    .doc-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.25rem 1.5rem;
      min-width: 0;
    }

    .doc-content::-webkit-scrollbar { width: 5px; }
    .doc-content::-webkit-scrollbar-track { background: transparent; }
    .doc-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .doc-content-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted);
      font-size: 0.82rem;
    }

    .doc-rendered {
      font-size: 0.85rem;
      line-height: 1.7;
      max-width: 800px;
    }

    .doc-rendered h2.md-h { font-size: 1.2rem; font-weight: 700; color: var(--accent); margin: 1.4em 0 0.5em; }
    .doc-rendered h3.md-h { font-size: 1.05rem; font-weight: 700; color: var(--accent); margin: 1.2em 0 0.4em; }
    .doc-rendered h4.md-h { font-size: 0.92rem; font-weight: 600; color: var(--accent); margin: 1em 0 0.3em; }
    .doc-rendered h5.md-h { font-size: 0.85rem; font-weight: 600; color: var(--accent); margin: 0.8em 0 0.3em; }
    .doc-rendered .md-h:first-child { margin-top: 0; }

    .doc-rendered p { margin: 0 0 0.7em; }
    .doc-rendered p:last-child { margin-bottom: 0; }

    .doc-rendered .md-list { margin: 0.3em 0 0.7em 1.5em; padding: 0; }
    .doc-rendered .md-list li { margin-bottom: 0.3em; }

    .doc-rendered .md-table { width: 100%; border-collapse: collapse; margin: 0.7em 0; font-size: 0.8rem; }
    .doc-rendered .md-table th,
    .doc-rendered .md-table td { padding: 0.4em 0.65em; border: 1px solid var(--border); text-align: left; }
    .doc-rendered .md-table th { background: rgba(255,255,255,0.05); font-weight: 600; color: var(--accent); }

    .doc-rendered .md-code {
      background: var(--bar);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.7em 0.9em;
      margin: 0.5em 0;
      font-family: var(--font-mono);
      font-size: 0.78rem;
      overflow-x: auto;
      white-space: pre;
    }

    .doc-rendered .md-inline-code {
      background: var(--bar);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 0.1em 0.35em;
      font-family: var(--font-mono);
      font-size: 0.8em;
    }

    .doc-rendered .md-hr { border: none; border-top: 1px solid var(--border); margin: 1em 0; }

    .doc-rendered .md-blockquote {
      border-left: 3px solid var(--accent-dim);
      padding: 0.4em 0.8em;
      margin: 0.5em 0;
      color: var(--muted);
      font-style: italic;
    }

    .doc-rendered a { color: var(--accent); text-decoration: underline; }
    .doc-rendered a:hover { color: var(--accent-hover); }

    .doc-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--muted);
      font-size: 0.82rem;
    }

    /* Notebook cells */
    .nb-cell {
      margin-bottom: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .nb-cell-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.25rem 0.6rem;
      background: var(--surface);
      color: var(--muted);
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .nb-cell-label .cell-num { color: var(--accent); font-family: var(--font-mono); }

    .nb-cell-body { padding: 0.6rem 0.8rem; }

    .nb-cell.nb-markdown .nb-cell-body { font-size: 0.82rem; line-height: 1.6; }

    .nb-cell.nb-code .nb-cell-body {
      background: var(--bar);
      font-family: var(--font-mono);
      font-size: 0.75rem;
      white-space: pre-wrap;
      overflow-x: auto;
    }

    .nb-output {
      border-top: 1px solid var(--border);
      padding: 0.5rem 0.8rem;
      background: rgba(0,0,0,0.15);
      font-family: var(--font-mono);
      font-size: 0.72rem;
      white-space: pre-wrap;
      color: var(--muted);
      max-height: 300px;
      overflow-y: auto;
    }

    .nb-output::-webkit-scrollbar { width: 4px; }
    .nb-output::-webkit-scrollbar-track { background: transparent; }
    .nb-output::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* ── Responsive ───────────────────────────────────── */
    @media (max-width: 768px) {
      .activity-bar {
        width: 42px;
      }
      .activity-bar.expanded { width: 160px; }
      .nav-toggle { display: none; }

      .activity-tab {
        height: 34px;
      }

      .activity-tab svg {
        width: 18px;
        height: 18px;
      }


      /* On mobile, only show one panel at a time */
      .panel.visible ~ .panel.visible {
        display: none;
      }

      .tool-list {
        width: 160px;
      }

      .msg-user { margin-left: 1.5rem; margin-right: 0.5rem; }
      .msg-assistant { margin-left: 0.5rem; margin-right: 1.5rem; }

      .user-email { max-width: 100px; }
      .doc-list { width: 160px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Philly Poverty Profiteering<span>Investigative Agent</span></h1>
    <div class="header-right">
      <select class="model-select" id="modelSelect" onchange="onModelChange()" title="Select AI model">
        <option value="gpt-4.1">GPT-4.1</option>
        <option value="gpt-5">GPT-5</option>
        <option value="gpt-5-mini">GPT-5 Mini</option>
        <option value="o4-mini">o4-mini</option>
        <option value="o3-mini">o3-mini</option>
        <option value="Phi-4">Phi-4</option>
      </select>
      <div class="status">
        <div class="status-dot"></div>
        <span>12 tools + 29M rows</span>
      </div>
      <div class="user-info" id="userInfo" style="display:none;">
        <span class="user-email" id="userEmail"></span>
        <button class="btn-logout" onclick="logout()">Sign out</button>
      </div>
    </div>
  </header>

  <div class="app-body">
    <!-- Activity Bar -->
    <nav class="activity-bar" id="activityBar">
      <button class="nav-toggle" onclick="toggleNav()" title="Expand menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"/>
        </svg>
      </button>
      <button class="activity-tab" id="tabAgent" onclick="togglePanel('agent')" title="Investigative Agent">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <span class="tab-text">Agent</span>
      </button>
      <button class="activity-tab" id="tabCity" onclick="togglePanel('city')" title="City Portal (Foundry Agent)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M2 22h20"/>
          <path d="M4 22V10l5-4 5 4v12"/>
          <rect x="7" y="15" width="4" height="7"/>
          <line x1="17" y1="22" x2="17" y2="3"/>
          <path d="M17 6c2-2 4-1 4 1"/>
        </svg>
        <span class="tab-text">City Portal</span>
      </button>
      <button class="activity-tab" id="tabCopilot" onclick="togglePanel('copilot')" title="Copilot Studio">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="9"/>
          <rect x="4" y="10" width="6" height="4" rx="2"/>
          <rect x="14" y="10" width="6" height="4" rx="2"/>
          <path d="M10 12h4"/>
        </svg>
        <span class="tab-text">Copilot</span>
      </button>
      <button class="activity-tab" id="tabSK" onclick="togglePanel('sk')" title="Semantic Kernel Agent">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="2" fill="currentColor" stroke="none"/>
          <ellipse cx="12" cy="12" rx="10" ry="4"/>
          <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(60 12 12)"/>
          <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(120 12 12)"/>
          <circle cx="22" cy="12" r="1.5" fill="currentColor" stroke="none"/>
          <circle cx="7" cy="8.1" r="1.5" fill="currentColor" stroke="none"/>
          <circle cx="7" cy="15.9" r="1.5" fill="currentColor" stroke="none"/>
        </svg>
        <span class="tab-text">SK Agent</span>
      </button>
      <button class="activity-tab" id="tabTools" onclick="togglePanel('tools')" title="MCP Tool Tester">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
        <span class="tab-text">Tools</span>
      </button>
      <div style="flex:1;"></div>
      <button class="activity-tab" id="tabDocs" onclick="togglePanel('docs')" title="Documentation">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
        </svg>
        <span class="tab-text">Docs</span>
      </button>
      <button class="activity-tab" id="tabAbout" onclick="togglePanel('about')" title="About This Site" style="margin-bottom:6px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <span class="tab-text">About</span>
      </button>
    </nav>

    <!-- Panel Area -->
    <div class="panel-area">
      <!-- Welcome screen (shown when no panels are open) -->
      <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-inner">
          <div class="welcome-map" id="welcomeMap"></div>
          <h2>Philadelphia Property Data</h2>
          <p>
            Investigate property ownership, code violations, demolitions, business licenses,
            and poverty profiteering patterns across Philadelphia using 29 million rows of public data.
          </p>
          <div class="welcome-actions">
            <button class="welcome-btn" onclick="togglePanel('agent')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              Open Agent
            </button>
            <button class="welcome-btn" onclick="togglePanel('city')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;">
                <path d="M2 22h20"/>
                <path d="M4 22V10l5-4 5 4v12"/>
                <rect x="7" y="15" width="4" height="7"/>
                <line x1="17" y1="22" x2="17" y2="3"/>
                <path d="M17 6c2-2 4-1 4 1"/>
              </svg>
              City Portal
            </button>
            <button class="welcome-btn" onclick="togglePanel('copilot')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;">
                <circle cx="12" cy="12" r="9"/>
                <rect x="4" y="10" width="6" height="4" rx="2"/>
                <rect x="14" y="10" width="6" height="4" rx="2"/>
                <path d="M10 12h4"/>
              </svg>
              Copilot Studio
            </button>
            <button class="welcome-btn" onclick="togglePanel('sk')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;">
                <!-- nucleus -->
                <circle cx="12" cy="12" r="2" fill="currentColor" stroke="none"/>
                <!-- three elliptical orbits -->
                <ellipse cx="12" cy="12" rx="10" ry="4"/>
                <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(60 12 12)"/>
                <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(120 12 12)"/>
                <!-- electrons -->
                <circle cx="22" cy="12" r="1.5" fill="currentColor" stroke="none"/>
                <circle cx="7" cy="8.1" r="1.5" fill="currentColor" stroke="none"/>
                <circle cx="7" cy="15.9" r="1.5" fill="currentColor" stroke="none"/>
              </svg>
              SK Agent
            </button>
            <button class="welcome-btn" onclick="togglePanel('tools')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
              </svg>
              Tools
            </button>
            <button class="welcome-btn" onclick="togglePanel('docs')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
              </svg>
              Docs
            </button>
            <button class="welcome-btn" onclick="togglePanel('about')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
              About
            </button>
          </div>
        </div>
      </div>

      <!-- Panel 1: Investigative Agent -->
      <div class="panel" id="panelAgent">
        <div class="panel-header">
          <span class="panel-header-title">Investigative Agent</span>
          <button class="btn-small" onclick="clearChat()">Clear</button>
        </div>
        <div class="chat-scroll" id="chatScroll">
          <div class="chat-welcome" id="chatWelcome">
            <h3>Ask a Question</h3>
            <p>
              Query property ownership, code violations, demolitions, business licenses,
              and poverty profiteering patterns. The agent uses 12 tools over 29M rows.
            </p>
            <div class="suggestions">
              <div class="suggestion" onclick="useSuggestion(this)">Who are the top 10 worst property owners by code violations?</div>
              <div class="suggestion" onclick="useSuggestion(this)">What check cashing businesses operate in zip code 19134?</div>
              <div class="suggestion" onclick="useSuggestion(this)">Tell me about GEENA LLC - how many properties and violations?</div>
              <div class="suggestion" onclick="useSuggestion(this)">Compare vacancy and violation rates between zip codes 19134 and 19140</div>
              <div class="suggestion" onclick="useSuggestion(this)">Find LLCs that own more than 50 properties with demolition records</div>
            </div>
          </div>
        </div>
        <div class="chat-input-area">
          <div class="chat-input-row">
            <div class="chat-input-wrap">
              <textarea id="chatInput" rows="1" placeholder="Ask about Philadelphia property data..."
                onkeydown="handleChatKey(event)" oninput="autoResize(this)"></textarea>
            </div>
            <button class="btn-send" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
          </div>
          <div class="chat-input-hint">Enter to send, Shift+Enter for new line</div>
        </div>
      </div>

      <!-- Panel 3: City Portal -->
      <div class="panel city-panel" id="panelCity">
        <div class="city-header-bar">
          <svg class="city-seal" viewBox="0 0 100 100" fill="none">
            <circle cx="50" cy="50" r="46" stroke="#f2c94c" stroke-width="3"/>
            <circle cx="50" cy="50" r="38" stroke="#f2c94c" stroke-width="1.5"/>
            <rect x="30" y="35" width="10" height="30" rx="1" fill="#f2c94c" opacity="0.9"/>
            <rect x="45" y="25" width="10" height="40" rx="1" fill="#f2c94c"/>
            <rect x="60" y="30" width="10" height="35" rx="1" fill="#f2c94c" opacity="0.9"/>
            <rect x="33" y="42" width="4" height="4" rx="0.5" fill="#004785"/>
            <rect x="33" y="50" width="4" height="4" rx="0.5" fill="#004785"/>
            <rect x="48" y="32" width="4" height="4" rx="0.5" fill="#004785"/>
            <rect x="48" y="40" width="4" height="4" rx="0.5" fill="#004785"/>
            <rect x="48" y="48" width="4" height="4" rx="0.5" fill="#004785"/>
            <rect x="63" y="37" width="4" height="4" rx="0.5" fill="#004785"/>
            <rect x="63" y="45" width="4" height="4" rx="0.5" fill="#004785"/>
            <line x1="25" y1="65" x2="75" y2="65" stroke="#f2c94c" stroke-width="2"/>
            <text x="50" y="80" text-anchor="middle" fill="#f2c94c" font-size="7" font-weight="700" font-family="serif">PHILADELPHIA</text>
          </svg>
          <div class="city-header-text">
            <h2>City of Philadelphia</h2>
            <p>Property Data Transparency Portal</p>
          </div>
        </div>
        <div class="city-content">
          <div class="city-intro">
            <h3>Property Data at Your Fingertips</h3>
            <p>
              This portal provides transparent access to Philadelphia's property data, including ownership records,
              code enforcement cases, demolition history, business licenses, and tax assessments. Our AI assistant
              can help you navigate and understand this data &mdash; click the chat icon in the bottom right to get started.
            </p>
          </div>
          <div class="city-stats-grid">
            <div class="city-stat-card">
              <div class="city-stat-value">584K</div>
              <div class="city-stat-label">Properties</div>
            </div>
            <div class="city-stat-card">
              <div class="city-stat-value">1.6M</div>
              <div class="city-stat-label">Code Investigations</div>
            </div>
            <div class="city-stat-card">
              <div class="city-stat-value">13.5K</div>
              <div class="city-stat-label">Demolition Records</div>
            </div>
          </div>
          <div class="city-about">
            <h4>About This Data</h4>
            <p>
              Data sourced from Philadelphia's open data portals, covering 10 public datasets with approximately
              29 million rows. This includes the OPA property registry, L&amp;I code enforcement cases, demolition
              permits, business and commercial activity licenses, zoning appeals, and historical tax assessments
              from 2015 to 2025.
            </p>
            <p style="margin-top:0.5rem;">
              The AI assistant uses the same 12 investigative tools and data pipeline as the Investigative Agent,
              powered by a Foundry Agent (Azure OpenAI Assistants API) with persistent conversation threads.
            </p>
          </div>
        </div>

        <!-- Floating chat button -->
        <button class="chat-fab" id="chatFab" onclick="toggleCityChat()" title="Chat with AI Assistant">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        </button>

        <!-- Chat widget overlay -->
        <div class="chat-widget" id="chatWidget">
          <div class="widget-header">
            <div>
              <div class="widget-header-title">Property Data Assistant</div>
              <div class="widget-header-sub">Powered by Foundry Agent</div>
            </div>
            <button class="widget-close" onclick="toggleCityChat()">&times;</button>
          </div>
          <div class="widget-messages" id="widgetMessages">
            <div class="widget-bubble system">Ask me anything about Philadelphia property data.</div>
          </div>
          <div class="widget-input-area">
            <input type="text" id="widgetInput" placeholder="Type a message..."
              onkeydown="if(event.key==='Enter'){event.preventDefault();sendWidgetMessage();}" />
            <button class="widget-send" id="widgetSendBtn" onclick="sendWidgetMessage()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Panel 4: Copilot Studio -->
      <div class="panel copilot-panel" id="panelCopilot">
        <div class="copilot-header-bar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="9"/>
            <rect x="4" y="10" width="6" height="4" rx="2"/>
            <rect x="14" y="10" width="6" height="4" rx="2"/>
            <path d="M10 12h4"/>
          </svg>
          <div class="copilot-header-text">
            <h2>Copilot Studio</h2>
            <p>Low-Code AI Agent via MCP</p>
          </div>
        </div>
        <div class="copilot-content">
          <div class="copilot-intro">
            <h3>Microsoft Copilot Studio Agent</h3>
            <p>
              This panel demonstrates a low-code/no-code approach to consuming the same 12 investigative tools.
              A Microsoft Copilot Studio agent is connected directly to our MCP endpoint &mdash; it automatically
              discovers all available tools and can answer questions about Philadelphia property data without any
              custom code.
            </p>
            <p>Click the chat icon in the bottom right to launch the Copilot Studio agent.</p>
          </div>
          <div class="copilot-features">
            <div class="copilot-feature-card">
              <h4>Auto-Discovery</h4>
              <p>Copilot Studio connects to the MCP endpoint and automatically discovers all 12 tools &mdash; no manual configuration needed.</p>
            </div>
            <div class="copilot-feature-card">
              <h4>No Custom Code</h4>
              <p>Unlike the Investigative Agent and City Portal, this agent requires zero custom code on the Copilot Studio side.</p>
            </div>
            <div class="copilot-feature-card">
              <h4>Same Backend</h4>
              <p>Uses the same APIM &rarr; Functions &rarr; SQL pipeline and 29M rows of Philadelphia property data.</p>
            </div>
          </div>
          <div class="copilot-about">
            <h4>How It Works</h4>
            <p>
              Copilot Studio connects to our MCP server endpoint at the Container App. When the agent receives a
              question, it uses MCP tool discovery to find the right tools, calls them through our APIM gateway,
              and synthesizes the results into a natural language response.
            </p>
            <p style="margin-top:0.5rem;">
              This is one of four client patterns demonstrated in this application: Chat Completions + Tools
              (Investigative Agent), Assistants API (City Portal), MCP via Low-Code (this panel), and Raw MCP
              Protocol (Tool Tester).
            </p>
          </div>
        </div>

        <!-- Floating chat button (scoped to this panel) -->
        <button class="copilot-fab" id="copilotFab" onclick="toggleCopilotWidget()" title="Launch Copilot Studio Agent">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="9"/>
            <rect x="4" y="10" width="6" height="4" rx="2"/>
            <rect x="14" y="10" width="6" height="4" rx="2"/>
            <path d="M10 12h4"/>
          </svg>
        </button>

        <!-- Chat widget overlay (scoped to this panel) -->
        <div class="copilot-widget" id="copilotWidget">
          <div class="copilot-widget-header">
            <span>Copilot Studio</span>
            <button onclick="toggleCopilotWidget()">&times;</button>
          </div>
          <iframe id="copilotFrame" src="" allow="microphone *" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </div>

      <!-- Panel 5: Documentation -->
      <div class="panel" id="panelDocs">
        <div class="panel-header">
          <span class="panel-header-title">Documentation</span>
          <span id="docTitle" style="font-size:0.72rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:300px;"></span>
        </div>
        <div class="docs-body">
          <div class="doc-list" id="docList"></div>
          <div class="doc-content" id="docContent">
            <div class="doc-content-empty">Select a document from the list.</div>
          </div>
        </div>
      </div>

      <!-- Panel 6: About This Site -->
      <div class="panel" id="panelAbout">
        <div class="panel-header">
          <span class="panel-header-title">About This Site</span>
        </div>
        <div class="about-body">
          <div class="about-content">
            <h2>What is this?</h2>
            <p>
              An AI-powered investigative platform that surfaces poverty profiteering patterns in Philadelphia.
              It combines <strong>10 public datasets</strong> (~29 million rows) covering property ownership, code violations,
              demolitions, business licenses, and tax assessments into a queryable system accessible through multiple AI interfaces.
            </p>
            <p>
              Everything runs on serverless Azure infrastructure and costs ~$1&ndash;2/month when idle. The same 12 investigative
              tools power every panel below &mdash; the difference is <em>how</em> each one connects to those tools.
            </p>

            <div class="about-cards">
              <div class="about-card">
                <div class="about-card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                  </svg>
                </div>
                <h3>Investigative Agent</h3>
                <span class="about-card-pattern">Chat Completions + Tools</span>
                <p>
                  Ask questions in plain English. The AI decides which tools to call, chains multiple lookups together,
                  and returns a narrative answer with maps. You pick the model (GPT-4.1, GPT-5, o4-mini, etc.).
                  Our code runs the reasoning loop.
                </p>
              </div>

              <div class="about-card">
                <div class="about-card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 22h20"/>
                    <path d="M4 22V10l5-4 5 4v12"/>
                    <rect x="7" y="15" width="4" height="7"/>
                    <line x1="17" y1="22" x2="17" y2="3"/>
                    <path d="M17 6c2-2 4-1 4 1"/>
                  </svg>
                </div>
                <h3>City Portal</h3>
                <span class="about-card-pattern">Azure AI Foundry &mdash; Assistants API</span>
                <p>
                  A Philadelphia city government&ndash;branded page with a floating chat widget.
                  Azure manages the tool-calling loop and conversation threads persist server-side,
                  so follow-up questions remember context. Powered by GPT-4.1 via Azure AI Foundry.
                </p>
              </div>

              <div class="about-card">
                <div class="about-card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="9"/>
                    <rect x="4" y="10" width="6" height="4" rx="2"/>
                    <rect x="14" y="10" width="6" height="4" rx="2"/>
                    <path d="M10 12h4"/>
                  </svg>
                </div>
                <h3>Copilot Studio</h3>
                <span class="about-card-pattern">Low-Code Agent via MCP</span>
                <p>
                  A Microsoft Copilot Studio agent that connects to our MCP endpoint and auto-discovers
                  all 12 tools &mdash; no custom code required. Demonstrates the low-code/no-code path
                  to building an AI agent on top of the same data.
                </p>
              </div>

              <div class="about-card">
                <div class="about-card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                  </svg>
                </div>
                <h3>Documentation</h3>
                <span class="about-card-pattern">Built-in Reader</span>
                <p>
                  Browse all project documentation and Jupyter notebooks without leaving the app.
                  Includes architecture deep-dives, a plain-English explainer, CLI cheatsheet, FAQ, and the full session log.
                </p>
              </div>

              <div class="about-card">
                <div class="about-card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                  </svg>
                </div>
                <h3>MCP Tool Tester</h3>
                <span class="about-card-pattern">Raw MCP Protocol</span>
                <p>
                  Connect directly to the MCP server, browse the 12 available tools, fill in parameters,
                  and see raw JSON responses. No AI involved &mdash; useful for debugging and understanding
                  exactly what data each tool returns.
                </p>
              </div>

              <div class="about-card">
                <div class="about-card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="6" cy="6" r="3"/>
                    <circle cx="18" cy="6" r="3"/>
                    <circle cx="12" cy="18" r="3"/>
                    <line x1="8.5" y1="7.5" x2="10" y2="16"/>
                    <line x1="15.5" y1="7.5" x2="14" y2="16"/>
                    <line x1="9" y1="6" x2="15" y2="6"/>
                  </svg>
                </div>
                <h3>Semantic Kernel Agent</h3>
                <span class="about-card-pattern">Multi-Agent Orchestration &mdash; C# / .NET</span>
                <p>
                  A team of specialist agents built with Microsoft Semantic Kernel. A Triage agent
                  routes your question to the right specialist &mdash; OwnerAnalyst, ViolationAnalyst,
                  or AreaAnalyst &mdash; each with focused tools. Shows agent handoff badges so you can
                  see which agents collaborated. The only C# component in the stack.
                </p>
              </div>
            </div>

            <div class="about-footer">
              <h3>The Big Picture</h3>
              <p>
                This application demonstrates four fundamentally different ways to build AI agents on the same backend:
                <strong>custom code</strong> (Investigative Agent), <strong>platform-managed</strong> (City Portal via Foundry),
                <strong>low-code</strong> (Copilot Studio via MCP), and <strong>enterprise SDK</strong> (Semantic Kernel with multi-agent orchestration).
                The underlying data, tools, and API are identical &mdash; only the integration pattern changes.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel 7: Semantic Kernel Agent -->
      <div class="panel" id="panelSK">
        <div class="panel-header">
          <span class="panel-header-title">Semantic Kernel Agent</span>
          <span style="font-size:0.65rem;color:var(--muted);margin-left:auto;">Multi-Agent &middot; C# &middot; HandoffOrchestration</span>
          <button class="btn-small" onclick="clearSKChat()" style="margin-left:0.5rem;">Clear</button>
        </div>
        <div class="chat-scroll" id="skChatScroll">
          <div class="chat-welcome" id="skChatWelcome">
            <h3>Semantic Kernel Multi-Agent</h3>
            <p>
              Ask a question and watch a team of specialist agents collaborate. A <strong>Triage</strong> agent
              routes your request to the right specialist &mdash; <strong>OwnerAnalyst</strong>,
              <strong>ViolationAnalyst</strong>, or <strong>AreaAnalyst</strong> &mdash; each with its own focused tool set.
              Built with Microsoft Semantic Kernel (C#) and HandoffOrchestration.
            </p>
            <div class="suggestions">
              <div class="suggestion" onclick="useSKSuggestion(this)">Who are the top 10 LLC violators in Philadelphia?</div>
              <div class="suggestion" onclick="useSKSuggestion(this)">Investigate GEENA LLC — properties, violations, and demolitions</div>
              <div class="suggestion" onclick="useSKSuggestion(this)">Compare vacancy and violation rates in 19134 vs 19140</div>
              <div class="suggestion" onclick="useSKSuggestion(this)">Find check cashing businesses in zip code 19134</div>
            </div>
          </div>
        </div>
        <div class="chat-input-area">
          <div class="chat-input-row">
            <div class="chat-input-wrap">
              <textarea id="skChatInput" rows="1" placeholder="Ask the multi-agent team..."
                onkeydown="handleSKChatKey(event)" oninput="autoResize(this)"></textarea>
            </div>
            <button class="btn-send" id="skChatSendBtn" onclick="sendSKMessage()">Send</button>
          </div>
          <div class="chat-input-hint">Enter to send, Shift+Enter for new line</div>
        </div>
      </div>

      <!-- Panel 2: MCP Tool Tester -->
      <div class="panel" id="panelTools">
        <div class="panel-header">
          <span class="panel-header-title">MCP Tool Tester</span>
          <span id="toolCount" style="font-size:0.7rem;color:var(--muted);"></span>
        </div>
        <div class="tools-connect">
          <div class="connect-row">
            <input type="text" id="mcpUrl" value="https://philly-mcp-server.victoriouspond-48a6f41b.eastus2.azurecontainerapps.io/mcp" placeholder="MCP endpoint URL" />
            <button class="btn-connect" id="btnConnect" onclick="mcpConnect()">Connect</button>
          </div>
          <div class="connect-status disconnected" id="connectStatus">
            Not connected
          </div>
        </div>
        <div class="tools-body">
          <div class="tool-list" id="toolList">
            <div class="tool-list-empty">Connect to an MCP server to discover tools.</div>
          </div>
          <div class="tool-detail" id="toolDetail">
            <div class="tool-detail-empty">Select a tool from the list.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ================================================================
       CONSTANTS & STATE
       ================================================================ */
    const API_BASE = 'https://philly-mcp-server.victoriouspond-48a6f41b.eastus2.azurecontainerapps.io';

    const state = {
      panels: { agent: false, tools: false, city: false, copilot: false, docs: false, about: false, sk: false },
      copilotOpen: false,
      chat: { history: [], isLoading: false, model: 'gpt-4.1' },
      city: { threadId: null, chatOpen: false, isLoading: false },
      docs: { selectedDoc: null, cache: {} },
      sk: { isLoading: false },
      mcp: {
        sessionId: null,
        connected: false,
        tools: [],
        selectedTool: null,
        callInProgress: false,
        timerInterval: null,
        timerStart: 0,
      },
    };

    const $ = (id) => document.getElementById(id);

    const DOCS_MANIFEST = {
      documentation: [
        { title: 'User Guide', path: '/docs/USER_GUIDE.md', type: 'md' },
        { title: 'FAQ', path: '/docs/FAQ.md', type: 'md' },
        { title: 'ELI5 (Plain English)', path: '/docs/ELI5.md', type: 'md' },
        { title: 'Architecture', path: '/docs/ARCHITECTURE.md', type: 'md' },
        { title: 'Commands Reference', path: '/docs/COMMANDS.md', type: 'md' },
        { title: 'CLI Cheatsheet', path: '/docs/CLI_CHEATSHEET.md', type: 'md' },
        { title: 'Prompts Library', path: '/docs/PROMPTS.md', type: 'md' },
        { title: 'Session Log', path: '/docs/SESSION_LOG.md', type: 'md' },
        { title: 'README', path: '/docs/README.md', type: 'md' },
      ],
      notebooks: [
        { title: 'Setup & Data Loading', path: '/notebooks/PhillyStat 01-Setup.ipynb', type: 'ipynb' },
        { title: 'Analytics', path: '/notebooks/PhillyStats-Analytics.ipynb', type: 'ipynb' },
        { title: 'LLC Analytics', path: '/notebooks/PhillyStats02-LLC-Analytics.ipynb', type: 'ipynb' },
      ],
    };

    /* ================================================================
       ESCAPING & FORMATTING
       ================================================================ */
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function formatContent(text) {
      if (!text) return '';
      var escaped = escapeHtml(text);
      var lines = escaped.split('\n');
      var out = [];
      var i = 0;

      while (i < lines.length) {
        var line = lines[i];

        // Code block
        if (line.match(/^```/)) {
          var code = [];
          i++;
          while (i < lines.length && !lines[i].match(/^```/)) {
            code.push(lines[i]);
            i++;
          }
          i++; // skip closing ```
          out.push('<pre class="md-code">' + code.join('\n') + '</pre>');
          continue;
        }

        // Table — detect header row with | separators
        if (line.indexOf('|') !== -1 && i + 1 < lines.length && lines[i + 1].match(/^\|?\s*[-:]+[-|\s:]*$/)) {
          var rows = [];
          while (i < lines.length && lines[i].indexOf('|') !== -1) {
            rows.push(lines[i]);
            i++;
          }
          // rows[0] = header, rows[1] = separator, rows[2+] = data
          var headerCells = rows[0].split('|').map(function(c) { return c.trim(); }).filter(Boolean);
          var html = '<table class="md-table"><thead><tr>';
          headerCells.forEach(function(c) { html += '<th>' + inlineFormat(c) + '</th>'; });
          html += '</tr></thead><tbody>';
          for (var r = 2; r < rows.length; r++) {
            var cells = rows[r].split('|').map(function(c) { return c.trim(); }).filter(Boolean);
            html += '<tr>';
            cells.forEach(function(c) { html += '<td>' + inlineFormat(c) + '</td>'; });
            html += '</tr>';
          }
          html += '</tbody></table>';
          out.push(html);
          continue;
        }

        // Horizontal rule
        if (line.match(/^[-*_]{3,}\s*$/)) {
          out.push('<hr class="md-hr"/>');
          i++;
          continue;
        }

        // Headers
        if (line.match(/^### /)) {
          out.push('<h4 class="md-h">' + inlineFormat(line.slice(4)) + '</h4>');
          i++;
          continue;
        }
        if (line.match(/^## /)) {
          out.push('<h3 class="md-h">' + inlineFormat(line.slice(3)) + '</h3>');
          i++;
          continue;
        }
        if (line.match(/^# /)) {
          out.push('<h3 class="md-h">' + inlineFormat(line.slice(2)) + '</h3>');
          i++;
          continue;
        }

        // Unordered list
        if (line.match(/^\s*[-*] /)) {
          var items = [];
          while (i < lines.length && lines[i].match(/^\s*[-*] /)) {
            items.push(lines[i].replace(/^\s*[-*] /, ''));
            i++;
          }
          out.push('<ul class="md-list">' + items.map(function(it) { return '<li>' + inlineFormat(it) + '</li>'; }).join('') + '</ul>');
          continue;
        }

        // Ordered list
        if (line.match(/^\s*\d+\.\s/)) {
          var items = [];
          while (i < lines.length && lines[i].match(/^\s*\d+\.\s/)) {
            items.push(lines[i].replace(/^\s*\d+\.\s/, ''));
            i++;
          }
          out.push('<ol class="md-list">' + items.map(function(it) { return '<li>' + inlineFormat(it) + '</li>'; }).join('') + '</ol>');
          continue;
        }

        // Blank line
        if (line.trim() === '') {
          i++;
          continue;
        }

        // Paragraph — collect consecutive non-blank, non-special lines
        var para = [];
        while (i < lines.length && lines[i].trim() !== '' && !lines[i].match(/^```/) && !lines[i].match(/^#{1,3} /) && !lines[i].match(/^\s*[-*] /) && !lines[i].match(/^\s*\d+\.\s/) && !lines[i].match(/^[-*_]{3,}\s*$/) && !(lines[i].indexOf('|') !== -1 && i + 1 < lines.length && lines[i + 1] && lines[i + 1].match(/^\|?\s*[-:]+[-|\s:]*$/))) {
          para.push(lines[i]);
          i++;
        }
        out.push('<p>' + inlineFormat(para.join(' ')) + '</p>');
      }

      return out.join('');
    }

    function inlineFormat(text) {
      // Bold
      text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Italic
      text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
      // Inline code
      text = text.replace(/`([^`]+)`/g, '<code class="md-inline-code">$1</code>');
      return text;
    }

    /* ================================================================
       PANEL MANAGEMENT
       ================================================================ */
    function toggleNav() {
      var bar = $('activityBar');
      bar.classList.toggle('expanded');
    }

    function togglePanel(name) {
      state.panels[name] = !state.panels[name];
      updatePanels();
      if (name === 'agent' && state.panels.agent) {
        setTimeout(() => $('chatInput') && $('chatInput').focus(), 50);
      }
      if (name === 'sk' && state.panels.sk) {
        setTimeout(() => $('skChatInput') && $('skChatInput').focus(), 50);
      }
    }

    function updatePanels() {
      const agentOpen = state.panels.agent;
      const toolsOpen = state.panels.tools;
      const cityOpen = state.panels.city;
      const copilotOpen = state.panels.copilot;
      const docsOpen = state.panels.docs;
      const aboutOpen = state.panels.about;
      const skOpen = state.panels.sk;

      // Activity bar tabs
      $('tabAgent').classList.toggle('active', agentOpen);
      $('tabTools').classList.toggle('active', toolsOpen);
      $('tabCity').classList.toggle('active', cityOpen);
      $('tabCopilot').classList.toggle('active', copilotOpen);
      $('tabDocs').classList.toggle('active', docsOpen);
      $('tabAbout').classList.toggle('active', aboutOpen);
      $('tabSK').classList.toggle('active', skOpen);

      // Panels
      $('panelAgent').classList.toggle('visible', agentOpen);
      $('panelTools').classList.toggle('visible', toolsOpen);
      $('panelCity').classList.toggle('visible', cityOpen);
      $('panelCopilot').classList.toggle('visible', copilotOpen);
      $('panelDocs').classList.toggle('visible', docsOpen);
      $('panelAbout').classList.toggle('visible', aboutOpen);
      $('panelSK').classList.toggle('visible', skOpen);

      // Hide model selector unless Investigative Agent is open
      const showModelSelect = agentOpen || (!agentOpen && !toolsOpen && !cityOpen && !copilotOpen && !docsOpen && !aboutOpen && !skOpen);
      $('modelSelect').style.display = showModelSelect ? '' : 'none';

      // Welcome screen
      const anyOpen = agentOpen || toolsOpen || cityOpen || copilotOpen || docsOpen || aboutOpen || skOpen;
      $('welcomeScreen').classList.toggle('hidden', anyOpen);

      // Close copilot widget if copilot panel is closed
      if (!copilotOpen && state.copilotOpen) {
        state.copilotOpen = false;
        $('copilotWidget').classList.remove('open');
      }

      // Re-init welcome map when it becomes visible
      if (!anyOpen) {
        setTimeout(function() {
          if (welcomeMapInstance) welcomeMapInstance.invalidateSize();
          else initWelcomeMap();
        }, 50);
      }
    }

    /* ================================================================
       CHAT - AGENT PANEL
       ================================================================ */
    function addChatMessage(role, content, toolCalls, locations) {
      const welcome = $('chatWelcome');
      if (welcome) welcome.remove();

      const container = $('chatScroll');
      const div = document.createElement('div');

      if (role === 'user') {
        div.className = 'message msg-user';
        div.innerHTML =
          '<div class="msg-label">You</div>' +
          '<div class="msg-content">' + escapeHtml(content) + '</div>';
      } else {
        div.className = 'message msg-assistant';
        let toolsHtml = '';
        if (toolCalls && toolCalls.length > 0) {
          toolsHtml = '<div class="msg-tools">' + toolCalls.map(function(tc) {
            return '<span class="tool-badge">' + escapeHtml(tc.name) + '</span>';
          }).join('') + '</div>';
        }
        div.innerHTML =
          '<div class="msg-label">Agent</div>' +
          '<div class="msg-content">' + formatContent(content) + '</div>' +
          toolsHtml;
      }

      container.appendChild(div);

      // Render map if locations are present
      if (locations && locations.length > 0) {
        createChatMap(locations, container);
      }

      container.scrollTop = container.scrollHeight;
    }

    function showThinking() {
      const container = $('chatScroll');
      const div = document.createElement('div');
      div.className = 'thinking';
      div.id = 'thinkingIndicator';
      div.innerHTML =
        '<div class="thinking-inner">' +
          '<div class="thinking-dots"><span></span><span></span><span></span></div>' +
          '<span class="thinking-label">Analyzing data...</span>' +
        '</div>';
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function hideThinking() {
      const el = $('thinkingIndicator');
      if (el) el.remove();
    }

    function showChatError(msg) {
      const container = $('chatScroll');
      const div = document.createElement('div');
      div.className = 'error-toast';
      div.textContent = msg;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      setTimeout(function() { div.remove(); }, 10000);
    }

    async function sendChatMessage() {
      const input = $('chatInput');
      const message = input.value.trim();
      if (!message || state.chat.isLoading) return;

      state.chat.isLoading = true;
      $('chatSendBtn').disabled = true;
      input.value = '';
      autoResize(input);

      addChatMessage('user', message);
      showThinking();

      try {
        const resp = await fetch(API_BASE + '/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: message, history: state.chat.history, model: state.chat.model }),
        });

        hideThinking();

        if (!resp.ok) {
          const errText = await resp.text();
          throw new Error('Server error (' + resp.status + '): ' + errText);
        }

        const data = await resp.json();
        addChatMessage('assistant', data.reply, data.toolCalls, data.locations);

        state.chat.history.push({ role: 'user', content: message });
        state.chat.history.push({ role: 'assistant', content: data.reply });

        if (state.chat.history.length > 40) {
          state.chat.history = state.chat.history.slice(-40);
        }
      } catch (err) {
        hideThinking();
        showChatError(err.message);
      } finally {
        state.chat.isLoading = false;
        $('chatSendBtn').disabled = false;
        input.focus();
      }
    }

    function handleChatKey(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    }

    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 140) + 'px';
    }

    function useSuggestion(el) {
      $('chatInput').value = el.textContent;
      sendChatMessage();
    }

    function clearChat() {
      state.chat.history = [];
      $('chatScroll').innerHTML =
        '<div class="chat-welcome" id="chatWelcome">' +
          '<h3>Ask a Question</h3>' +
          '<p>Query property ownership, code violations, demolitions, business licenses, ' +
          'and poverty profiteering patterns. The agent uses 12 tools over 29M rows.</p>' +
          '<div class="suggestions">' +
            '<div class="suggestion" onclick="useSuggestion(this)">Who are the top 10 worst property owners by code violations?</div>' +
            '<div class="suggestion" onclick="useSuggestion(this)">What check cashing businesses operate in zip code 19134?</div>' +
            '<div class="suggestion" onclick="useSuggestion(this)">Tell me about GEENA LLC - how many properties and violations?</div>' +
            '<div class="suggestion" onclick="useSuggestion(this)">Compare vacancy and violation rates between zip codes 19134 and 19140</div>' +
            '<div class="suggestion" onclick="useSuggestion(this)">Find LLCs that own more than 50 properties with demolition records</div>' +
          '</div>' +
        '</div>';
    }

    /* ================================================================
       MCP - TOOL TESTER PANEL
       ================================================================ */
    async function mcpSend(method, params, expectSse) {
      const url = $('mcpUrl').value.trim();
      if (!url) throw new Error('No MCP URL provided');

      const id = Date.now();
      const body = { jsonrpc: '2.0', id: id, method: method, params: params || {} };
      const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json, text/event-stream' };
      if (state.mcp.sessionId) {
        headers['mcp-session-id'] = state.mcp.sessionId;
      }

      const resp = await fetch(url, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(body),
      });

      // Capture session ID
      const sid = resp.headers.get('mcp-session-id');
      if (sid) state.mcp.sessionId = sid;

      if (!resp.ok) {
        const errText = await resp.text();
        throw new Error('MCP error (' + resp.status + '): ' + errText);
      }

      const contentType = resp.headers.get('content-type') || '';

      if (contentType.includes('text/event-stream')) {
        // Parse SSE response
        const text = await resp.text();
        const lines = text.split('\n');
        let lastData = null;
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line.startsWith('data: ')) {
            try {
              lastData = JSON.parse(line.substring(6));
            } catch (e) { /* skip non-JSON lines */ }
          }
        }
        if (lastData) return lastData;
        throw new Error('No valid data in SSE response');
      }

      return await resp.json();
    }

    async function mcpNotify(method, params) {
      const url = $('mcpUrl').value.trim();
      if (!url) return;

      const body = { jsonrpc: '2.0', method: method, params: params || {} };
      const headers = { 'Content-Type': 'application/json' };
      if (state.mcp.sessionId) {
        headers['mcp-session-id'] = state.mcp.sessionId;
      }

      await fetch(url, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(body),
      });
    }

    function setConnectStatus(cls, text) {
      const el = $('connectStatus');
      el.className = 'connect-status ' + cls;
      el.textContent = text;
    }

    /* ================================================================
       Semantic Kernel Agent Functions
       ================================================================ */
    var SK_API_BASE = 'https://philly-sk-agent.victoriouspond-48a6f41b.eastus2.azurecontainerapps.io';

    function useSKSuggestion(el) {
      $('skChatInput').value = el.textContent;
      $('skChatInput').focus();
    }

    function handleSKChatKey(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendSKMessage();
      }
    }

    function clearSKChat() {
      $('skChatScroll').innerHTML =
        '<div class="chat-welcome" id="skChatWelcome">' +
          '<h3>Semantic Kernel Multi-Agent</h3>' +
          '<p>Ask a question and watch a team of specialist agents collaborate.</p>' +
          '<div class="suggestions">' +
            '<div class="suggestion" onclick="useSKSuggestion(this)">Who are the top 10 LLC violators in Philadelphia?</div>' +
            '<div class="suggestion" onclick="useSKSuggestion(this)">Investigate GEENA LLC — properties, violations, and demolitions</div>' +
            '<div class="suggestion" onclick="useSKSuggestion(this)">Compare vacancy and violation rates in 19134 vs 19140</div>' +
            '<div class="suggestion" onclick="useSKSuggestion(this)">Find check cashing businesses in zip code 19134</div>' +
          '</div>' +
        '</div>';
    }

    function addSKMessage(role, content, agents, toolCalls, execTime) {
      var welcome = $('skChatWelcome');
      if (welcome) welcome.remove();

      var container = $('skChatScroll');
      var div = document.createElement('div');

      if (role === 'user') {
        div.className = 'message msg-user';
        div.innerHTML =
          '<div class="msg-label">You</div>' +
          '<div class="msg-content">' + escapeHtml(content) + '</div>';
      } else {
        div.className = 'message msg-assistant';

        // Agent handoff badges
        var agentsHtml = '';
        if (agents && agents.length > 0) {
          agentsHtml = '<div class="sk-agents-row">';
          for (var i = 0; i < agents.length; i++) {
            if (i > 0) agentsHtml += '<span class="sk-agent-arrow">&rarr;</span>';
            agentsHtml += '<span class="sk-agent-badge">' + escapeHtml(agents[i]) + '</span>';
          }
          agentsHtml += '</div>';
        }

        // Tool badges
        var toolsHtml = '';
        if (toolCalls && toolCalls.length > 0) {
          toolsHtml = '<div class="msg-tools">';
          for (var i = 0; i < toolCalls.length; i++) {
            var tc = toolCalls[i];
            var label = tc.agent ? tc.agent + '/' + tc.name : tc.name;
            toolsHtml += '<span class="tool-badge">' + escapeHtml(label) + '</span>';
          }
          toolsHtml += '</div>';
        }

        // Execution time
        var timeHtml = '';
        if (execTime) {
          timeHtml = '<div class="sk-time">' + (execTime / 1000).toFixed(1) + 's</div>';
        }

        div.innerHTML =
          '<div class="msg-label">SK Agent</div>' +
          '<div class="msg-content">' + formatContent(content) + '</div>' +
          agentsHtml + toolsHtml + timeHtml;
      }

      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    async function sendSKMessage() {
      var input = $('skChatInput');
      var message = input.value.trim();
      if (!message || state.sk.isLoading) return;

      state.sk.isLoading = true;
      $('skChatSendBtn').disabled = true;
      input.value = '';
      autoResize(input);

      addSKMessage('user', message);

      // Show thinking with live timer
      var container = $('skChatScroll');
      var thinking = document.createElement('div');
      thinking.className = 'thinking';
      thinking.id = 'skThinking';
      thinking.innerHTML =
        '<div class="thinking-inner">' +
          '<div class="thinking-dots"><span></span><span></span><span></span></div>' +
          '<span class="thinking-label">Agents collaborating...</span>' +
          '<span class="thinking-timer" id="skTimer">0s</span>' +
        '</div>' +
        '<div class="thinking-phases" id="skPhase">Routing to specialist agent...</div>';
      container.appendChild(thinking);
      container.scrollTop = container.scrollHeight;

      // Live timer + rotating status
      var skTimerStart = Date.now();
      var skTimerInterval = setInterval(function() {
        var elapsed = Math.floor((Date.now() - skTimerStart) / 1000);
        var timerEl = $('skTimer');
        if (timerEl) timerEl.textContent = elapsed + 's';
        var phaseEl = $('skPhase');
        if (phaseEl) {
          if (elapsed < 3) phaseEl.textContent = 'Routing to specialist agent...';
          else if (elapsed < 8) phaseEl.textContent = 'Agent calling Philadelphia data APIs...';
          else if (elapsed < 15) phaseEl.textContent = 'Processing results from Azure SQL...';
          else if (elapsed < 25) phaseEl.textContent = 'Synthesizing findings...';
          else phaseEl.textContent = 'Still working — complex queries take longer...';
        }
      }, 1000);

      try {
        var resp = await fetch(SK_API_BASE + '/investigate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: message }),
        });

        clearInterval(skTimerInterval);
        var el = $('skThinking');
        if (el) el.remove();

        if (!resp.ok) {
          var errText = await resp.text();
          throw new Error('Server error (' + resp.status + '): ' + errText);
        }

        var data = await resp.json();
        addSKMessage('assistant', data.reply, data.agents, data.toolCalls, data.executionTimeMs);
      } catch (err) {
        clearInterval(skTimerInterval);
        var el = $('skThinking');
        if (el) el.remove();
        var errDiv = document.createElement('div');
        errDiv.className = 'error-toast';
        errDiv.textContent = err.message;
        container.appendChild(errDiv);
        container.scrollTop = container.scrollHeight;
        setTimeout(function() { errDiv.remove(); }, 10000);
      } finally {
        state.sk.isLoading = false;
        $('skChatSendBtn').disabled = false;
        input.focus();
      }
    }

    async function mcpConnect() {
      const btn = $('btnConnect');
      btn.disabled = true;
      setConnectStatus('disconnected', 'Connecting...');
      state.mcp.sessionId = null;
      state.mcp.connected = false;
      state.mcp.tools = [];
      state.mcp.selectedTool = null;

      try {
        // Initialize
        const initResult = await mcpSend('initialize', {
          protocolVersion: '2024-11-05',
          capabilities: {},
          clientInfo: { name: 'philly-harness', version: '1.0' },
        });

        // Send initialized notification
        await mcpNotify('notifications/initialized', {});

        // List tools
        const toolsResult = await mcpSend('tools/list', {});
        const tools = (toolsResult.result && toolsResult.result.tools) ? toolsResult.result.tools : [];

        state.mcp.tools = tools;
        state.mcp.connected = true;

        setConnectStatus('connected', 'Connected \u2014 ' + tools.length + ' tools discovered');
        $('toolCount').textContent = tools.length + ' tools';
        renderToolList();
      } catch (err) {
        setConnectStatus('error', 'Failed: ' + err.message);
      } finally {
        btn.disabled = false;
      }
    }

    function renderToolList() {
      const container = $('toolList');
      const tools = state.mcp.tools;

      if (tools.length === 0) {
        container.innerHTML = '<div class="tool-list-empty">No tools discovered.</div>';
        return;
      }

      let html = '<div class="tool-list-header">Discovered Tools (' + tools.length + ')</div>';
      for (let i = 0; i < tools.length; i++) {
        const t = tools[i];
        const isActive = state.mcp.selectedTool === t.name;
        const desc = t.description ? t.description.substring(0, 60) : '';
        html += '<div class="tool-list-item' + (isActive ? ' active' : '') + '" onclick="selectTool(\'' + escapeHtml(t.name) + '\')">' +
          '<div>' + escapeHtml(t.name) + '</div>' +
          '<div class="tool-desc">' + escapeHtml(desc) + '</div>' +
        '</div>';
      }
      container.innerHTML = html;
    }

    function selectTool(name) {
      state.mcp.selectedTool = name;
      renderToolList();
      renderToolDetail();
    }

    function renderToolDetail() {
      const container = $('toolDetail');
      const name = state.mcp.selectedTool;

      if (!name) {
        container.innerHTML = '<div class="tool-detail-empty">Select a tool from the list.</div>';
        return;
      }

      const tool = state.mcp.tools.find(function(t) { return t.name === name; });
      if (!tool) return;

      let html = '<div class="tool-name">' + escapeHtml(tool.name) + '</div>';
      html += '<div class="tool-full-desc">' + escapeHtml(tool.description || '') + '</div>';

      // Parameters
      const schema = tool.inputSchema;
      if (schema && schema.properties) {
        const required = schema.required || [];
        const props = Object.keys(schema.properties);

        for (let i = 0; i < props.length; i++) {
          const pName = props[i];
          const pDef = schema.properties[pName];
          const isReq = required.indexOf(pName) >= 0;

          html += '<div class="param-group">';
          html += '<div class="param-label"><code>' + escapeHtml(pName) + '</code> ';
          html += isReq
            ? '<span class="param-required">required</span>'
            : '<span class="param-optional">optional</span>';
          html += '</div>';
          if (pDef.description) {
            html += '<div class="param-desc">' + escapeHtml(pDef.description) + '</div>';
          }
          html += '<input class="param-input" data-param="' + escapeHtml(pName) + '" ' +
            'data-type="' + escapeHtml(pDef.type || 'string') + '" ' +
            'placeholder="' + escapeHtml(pDef.type || 'string') + '" />';
          html += '</div>';
        }
      }

      html += '<div class="tool-actions">' +
        '<button class="btn-call" id="btnCallTool" onclick="callTool()">Call Tool</button>' +
        '<span class="call-timer" id="callTimer"></span>' +
      '</div>';
      html += '<div class="tool-result-area" id="toolResultArea"></div>';

      container.innerHTML = html;
    }

    async function callTool() {
      if (state.mcp.callInProgress) return;
      const name = state.mcp.selectedTool;
      if (!name || !state.mcp.connected) return;

      const tool = state.mcp.tools.find(function(t) { return t.name === name; });
      if (!tool) return;

      // Gather params
      const args = {};
      const inputs = $('toolDetail').querySelectorAll('.param-input');
      for (let i = 0; i < inputs.length; i++) {
        const inp = inputs[i];
        const val = inp.value.trim();
        if (val === '') continue;

        const pType = inp.getAttribute('data-type');
        const pName = inp.getAttribute('data-param');

        if (pType === 'number') {
          args[pName] = Number(val);
        } else if (pType === 'boolean') {
          args[pName] = val === 'true' || val === '1';
        } else {
          args[pName] = val;
        }
      }

      state.mcp.callInProgress = true;
      $('btnCallTool').disabled = true;

      // Start timer
      state.mcp.timerStart = Date.now();
      const timerEl = $('callTimer');
      timerEl.className = 'call-timer active';
      timerEl.textContent = '0.0s';
      state.mcp.timerInterval = setInterval(function() {
        const elapsed = ((Date.now() - state.mcp.timerStart) / 1000).toFixed(1);
        timerEl.textContent = elapsed + 's';
      }, 100);

      const resultArea = $('toolResultArea');
      resultArea.innerHTML =
        '<div class="tool-result-label">Result</div>' +
        '<div class="tool-result" style="color:var(--muted);">Calling ' + escapeHtml(name) + '...</div>';

      try {
        const resp = await mcpSend('tools/call', { name: name, arguments: args });

        clearInterval(state.mcp.timerInterval);
        const elapsed = ((Date.now() - state.mcp.timerStart) / 1000).toFixed(1);
        timerEl.className = 'call-timer';
        timerEl.textContent = elapsed + 's';

        const formatted = JSON.stringify(resp.result || resp, null, 2);
        resultArea.innerHTML =
          '<div class="tool-result-label">Result (' + elapsed + 's)</div>' +
          '<div class="tool-result">' + escapeHtml(formatted) + '</div>';
      } catch (err) {
        clearInterval(state.mcp.timerInterval);
        const elapsed = ((Date.now() - state.mcp.timerStart) / 1000).toFixed(1);
        timerEl.className = 'call-timer';
        timerEl.textContent = elapsed + 's';

        resultArea.innerHTML =
          '<div class="tool-result-label">Error (' + elapsed + 's)</div>' +
          '<div class="tool-result error">' + escapeHtml(err.message) + '</div>';
      } finally {
        state.mcp.callInProgress = false;
        $('btnCallTool').disabled = false;
      }
    }

    /* ================================================================
       CITY PORTAL - FOUNDRY AGENT CHAT WIDGET
       ================================================================ */
    async function toggleCityChat() {
      state.city.chatOpen = !state.city.chatOpen;
      $('chatWidget').classList.toggle('open', state.city.chatOpen);

      if (state.city.chatOpen && !state.city.threadId) {
        // Create a new agent thread on first open
        addWidgetMessage('system', 'Connecting to agent...');
        try {
          const resp = await fetch(API_BASE + '/agent/thread', { method: 'POST' });
          if (!resp.ok) throw new Error('Failed to create thread (' + resp.status + ')');
          const data = await resp.json();
          state.city.threadId = data.threadId;
          addWidgetMessage('system', 'Connected. Ask me anything!');
        } catch (err) {
          addWidgetMessage('system', 'Connection failed: ' + err.message);
        }
        $('widgetInput').focus();
      }
    }

    function addWidgetMessage(role, content, toolCalls) {
      const container = $('widgetMessages');
      const div = document.createElement('div');
      div.className = 'widget-bubble ' + role;

      if (role === 'assistant') {
        let toolsHtml = '';
        if (toolCalls && toolCalls.length > 0) {
          toolsHtml = '<div class="widget-tools">' + toolCalls.map(function(tc) {
            return '<span class="widget-tool-badge">' + escapeHtml(tc.name) + '</span>';
          }).join('') + '</div>';
        }
        div.innerHTML = formatContent(content) + toolsHtml;
      } else {
        div.textContent = content;
      }

      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function showWidgetThinking() {
      const container = $('widgetMessages');
      const div = document.createElement('div');
      div.className = 'widget-thinking';
      div.id = 'widgetThinking';
      div.innerHTML =
        '<div class="widget-thinking-dots"><span></span><span></span><span></span></div>' +
        '<span class="widget-thinking-label">Investigating...</span>';
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function hideWidgetThinking() {
      const el = $('widgetThinking');
      if (el) el.remove();
    }

    async function sendWidgetMessage() {
      const input = $('widgetInput');
      const message = input.value.trim();
      if (!message || state.city.isLoading || !state.city.threadId) return;

      state.city.isLoading = true;
      $('widgetSendBtn').disabled = true;
      input.value = '';

      addWidgetMessage('user', message);
      showWidgetThinking();

      try {
        const resp = await fetch(API_BASE + '/agent/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ threadId: state.city.threadId, message: message }),
        });

        hideWidgetThinking();

        if (!resp.ok) {
          const errText = await resp.text();
          throw new Error('Error (' + resp.status + '): ' + errText);
        }

        const data = await resp.json();
        addWidgetMessage('assistant', data.reply, data.toolCalls);
      } catch (err) {
        hideWidgetThinking();
        addWidgetMessage('system', err.message);
      } finally {
        state.city.isLoading = false;
        $('widgetSendBtn').disabled = false;
        input.focus();
      }
    }

    /* ================================================================
       MODEL SELECTOR
       ================================================================ */
    function onModelChange() {
      state.chat.model = $('modelSelect').value;
    }

    // Fetch available models from the server (updates dropdown if server has different models)
    async function loadModels() {
      try {
        const resp = await fetch(API_BASE + '/models');
        if (resp.ok) {
          const data = await resp.json();
          if (data.models && data.models.length > 0) {
            const select = $('modelSelect');
            select.innerHTML = data.models.map(function(m) {
              return '<option value="' + escapeHtml(m.id) + '">' + escapeHtml(m.label) + '</option>';
            }).join('');
            state.chat.model = select.value;
          }
        }
      } catch (e) { /* ignore — use hardcoded defaults */ }
    }

    /* ================================================================
       COPILOT STUDIO FLOATING WIDGET
       ================================================================ */
    const COPILOT_WEBCHAT_URL = 'https://copilotstudio.microsoft.com/environments/0582014c-9a6d-e35b-8705-5168c385f413/bots/copilots_header_80f1b/webchat?__version__=2';

    function toggleCopilotWidget() {
      state.copilotOpen = !state.copilotOpen;
      $('copilotWidget').classList.toggle('open', state.copilotOpen);
      var frame = $('copilotFrame');
      if (state.copilotOpen) {
        // Force-reload iframe each time to avoid stale session / JS errors
        frame.src = '';
        setTimeout(function() { frame.src = COPILOT_WEBCHAT_URL; }, 50);
      }
    }

    /* ================================================================
       AUTH - USER INFO
       ================================================================ */
    async function loadUserInfo() {
      try {
        const resp = await fetch('/.auth/me');
        if (!resp.ok) return;
        const data = await resp.json();
        const principal = data.clientPrincipal;
        if (principal && principal.userDetails) {
          $('userEmail').textContent = principal.userDetails;
          $('userInfo').style.display = '';
        }
      } catch (e) { /* ignore - user info is non-critical */ }
    }

    function logout() {
      window.location.href = '/.auth/logout';
    }

    /* ================================================================
       DOCS PANEL
       ================================================================ */
    function slugify(text) {
      // Match GitHub's slug algorithm: each space becomes one hyphen, double hyphens preserved
      return text.toLowerCase()
        .replace(/&amp;/g, '').replace(/&lt;/g, '').replace(/&gt;/g, '').replace(/&quot;/g, '')
        .replace(/[^\w\s-]/g, '').replace(/\s/g, '-').replace(/^-|-$/g, '');
    }

    function inlineFormatDoc(text) {
      // Links [text](url) — anchor links scroll within doc panel, external links open new tab
      text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, linkText, url) {
        if (url.startsWith('#')) {
          var targetId = url.slice(1);
          return '<a href="javascript:void(0)" onclick="scrollDocTo(\'' + targetId.replace(/'/g, "\\'") + '\')">' + linkText + '</a>';
        }
        return '<a href="' + url + '" target="_blank" rel="noopener">' + linkText + '</a>';
      });
      // Images ![alt](attachment:...) → placeholder
      text = text.replace(/!\[([^\]]*)\]\(attachment:[^)]+\)/g, '<em style="color:var(--muted);">[Image: $1]</em>');
      // Images ![alt](http...)
      text = text.replace(/!\[([^\]]*)\]\((https?:[^)]+)\)/g, '<img src="$2" alt="$1" style="max-width:100%;border-radius:6px;margin:0.3em 0;" />');
      // Bold
      text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Italic
      text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
      // Inline code
      text = text.replace(/`([^`]+)`/g, '<code class="md-inline-code">$1</code>');
      return text;
    }

    function formatContentDoc(text) {
      if (!text) return '';
      var escaped = escapeHtml(text);
      var lines = escaped.split('\n');
      var out = [];
      var i = 0;

      while (i < lines.length) {
        var line = lines[i];

        // Code block
        if (line.match(/^```/)) {
          var code = [];
          i++;
          while (i < lines.length && !lines[i].match(/^```/)) {
            code.push(lines[i]);
            i++;
          }
          i++;
          out.push('<pre class="md-code">' + code.join('\n') + '</pre>');
          continue;
        }

        // Table
        if (line.indexOf('|') !== -1 && i + 1 < lines.length && lines[i + 1] && lines[i + 1].match(/^\|?\s*[-:]+[-|\s:]*$/)) {
          var rows = [];
          while (i < lines.length && lines[i].indexOf('|') !== -1) {
            rows.push(lines[i]);
            i++;
          }
          var headerCells = rows[0].split('|').map(function(c) { return c.trim(); }).filter(Boolean);
          var html = '<table class="md-table"><thead><tr>';
          headerCells.forEach(function(c) { html += '<th>' + inlineFormatDoc(c) + '</th>'; });
          html += '</tr></thead><tbody>';
          for (var r = 2; r < rows.length; r++) {
            var cells = rows[r].split('|').map(function(c) { return c.trim(); }).filter(Boolean);
            html += '<tr>';
            cells.forEach(function(c) { html += '<td>' + inlineFormatDoc(c) + '</td>'; });
            html += '</tr>';
          }
          html += '</tbody></table>';
          out.push(html);
          continue;
        }

        // Horizontal rule
        if (line.match(/^[-*_]{3,}\s*$/)) {
          out.push('<hr class="md-hr"/>');
          i++;
          continue;
        }

        // Blockquote
        if (line.match(/^&gt;\s?/)) {
          var bqLines = [];
          while (i < lines.length && lines[i].match(/^&gt;\s?/)) {
            bqLines.push(lines[i].replace(/^&gt;\s?/, ''));
            i++;
          }
          out.push('<div class="md-blockquote">' + inlineFormatDoc(bqLines.join(' ')) + '</div>');
          continue;
        }

        // Headers with proper hierarchy + id for anchor links
        if (line.match(/^#### /)) {
          var hText = line.slice(5);
          out.push('<h5 class="md-h" id="' + slugify(hText) + '">' + inlineFormatDoc(hText) + '</h5>');
          i++; continue;
        }
        if (line.match(/^### /)) {
          var hText = line.slice(4);
          out.push('<h4 class="md-h" id="' + slugify(hText) + '">' + inlineFormatDoc(hText) + '</h4>');
          i++; continue;
        }
        if (line.match(/^## /)) {
          var hText = line.slice(3);
          out.push('<h3 class="md-h" id="' + slugify(hText) + '">' + inlineFormatDoc(hText) + '</h3>');
          i++; continue;
        }
        if (line.match(/^# /)) {
          var hText = line.slice(2);
          out.push('<h2 class="md-h" id="' + slugify(hText) + '">' + inlineFormatDoc(hText) + '</h2>');
          i++; continue;
        }

        // Unordered list
        if (line.match(/^\s*[-*] /)) {
          var items = [];
          while (i < lines.length && lines[i].match(/^\s*[-*] /)) {
            items.push(lines[i].replace(/^\s*[-*] /, ''));
            i++;
          }
          out.push('<ul class="md-list">' + items.map(function(it) { return '<li>' + inlineFormatDoc(it) + '</li>'; }).join('') + '</ul>');
          continue;
        }

        // Ordered list
        if (line.match(/^\s*\d+\.\s/)) {
          var items = [];
          while (i < lines.length && lines[i].match(/^\s*\d+\.\s/)) {
            items.push(lines[i].replace(/^\s*\d+\.\s/, ''));
            i++;
          }
          out.push('<ol class="md-list">' + items.map(function(it) { return '<li>' + inlineFormatDoc(it) + '</li>'; }).join('') + '</ol>');
          continue;
        }

        // Blank line
        if (line.trim() === '') { i++; continue; }

        // Paragraph
        var para = [];
        while (i < lines.length && lines[i].trim() !== '' && !lines[i].match(/^```/) && !lines[i].match(/^#{1,4} /) && !lines[i].match(/^\s*[-*] /) && !lines[i].match(/^\s*\d+\.\s/) && !lines[i].match(/^[-*_]{3,}\s*$/) && !lines[i].match(/^&gt;\s?/) && !(lines[i].indexOf('|') !== -1 && i + 1 < lines.length && lines[i + 1] && lines[i + 1].match(/^\|?\s*[-:]+[-|\s:]*$/))) {
          para.push(lines[i]);
          i++;
        }
        out.push('<p>' + inlineFormatDoc(para.join(' ')) + '</p>');
      }

      return out.join('');
    }

    function renderNotebook(jsonText) {
      try {
        var nb = JSON.parse(jsonText);
      } catch (e) {
        return '<div class="doc-content-empty" style="color:var(--error);">Invalid notebook JSON</div>';
      }

      var cells = nb.cells || [];
      var html = '<div class="doc-rendered">';
      var codeNum = 0;

      for (var i = 0; i < cells.length; i++) {
        var cell = cells[i];
        var source = Array.isArray(cell.source) ? cell.source.join('') : (cell.source || '');

        if (cell.cell_type === 'markdown') {
          html += '<div class="nb-cell nb-markdown">';
          html += '<div class="nb-cell-label">Markdown</div>';
          html += '<div class="nb-cell-body">' + formatContentDoc(source) + '</div>';
          html += '</div>';
        } else if (cell.cell_type === 'code') {
          codeNum++;
          var lang = source.match(/^%%sql/) ? 'sql' : ((nb.metadata && nb.metadata.kernelspec && nb.metadata.kernelspec.language) || 'python');

          html += '<div class="nb-cell nb-code">';
          html += '<div class="nb-cell-label"><span class="cell-num">[' + codeNum + ']</span> ' + escapeHtml(lang) + '</div>';
          html += '<div class="nb-cell-body">' + escapeHtml(source) + '</div>';

          var outputs = cell.outputs || [];
          for (var j = 0; j < outputs.length; j++) {
            var out = outputs[j];
            var outText = '';

            if (out.text) {
              outText = Array.isArray(out.text) ? out.text.join('') : out.text;
            } else if (out.data) {
              if (out.data['text/plain']) {
                outText = Array.isArray(out.data['text/plain']) ? out.data['text/plain'].join('') : out.data['text/plain'];
              }
            }

            if (outText) {
              if (outText.length > 5000) outText = outText.substring(0, 5000) + '\n... (truncated)';
              html += '<div class="nb-output">' + escapeHtml(outText) + '</div>';
            }
          }

          html += '</div>';
        }
      }

      html += '</div>';
      return html;
    }

    function renderDocList() {
      var container = $('docList');
      var html = '';

      html += '<div class="doc-list-header">Documentation (' + DOCS_MANIFEST.documentation.length + ')</div>';
      for (var i = 0; i < DOCS_MANIFEST.documentation.length; i++) {
        var doc = DOCS_MANIFEST.documentation[i];
        var isActive = state.docs.selectedDoc && state.docs.selectedDoc.path === doc.path;
        html += '<div class="doc-list-item' + (isActive ? ' active' : '') + '" onclick="selectDoc(\'' + doc.path.replace(/'/g, "\\'") + '\')">' +
          '<svg class="doc-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>' +
          escapeHtml(doc.title) +
        '</div>';
      }

      html += '<div class="doc-list-header" style="margin-top:0.25rem;">Notebooks (' + DOCS_MANIFEST.notebooks.length + ')</div>';
      for (var i = 0; i < DOCS_MANIFEST.notebooks.length; i++) {
        var nb = DOCS_MANIFEST.notebooks[i];
        var isActive = state.docs.selectedDoc && state.docs.selectedDoc.path === nb.path;
        html += '<div class="doc-list-item' + (isActive ? ' active' : '') + '" onclick="selectDoc(\'' + nb.path.replace(/'/g, "\\'") + '\')">' +
          '<svg class="doc-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="2"/><line x1="8" y1="3" x2="8" y2="21"/></svg>' +
          escapeHtml(nb.title) +
        '</div>';
      }

      container.innerHTML = html;
    }

    function findDocByPath(path) {
      var all = DOCS_MANIFEST.documentation.concat(DOCS_MANIFEST.notebooks);
      return all.find(function(d) { return d.path === path; });
    }

    async function selectDoc(path) {
      var doc = findDocByPath(path);
      if (!doc) return;

      state.docs.selectedDoc = doc;
      renderDocList();
      $('docTitle').textContent = doc.title;

      var content = $('docContent');
      content.innerHTML = '<div class="doc-loading">Loading...</div>';

      try {
        if (state.docs.cache[path]) {
          renderDocContent(state.docs.cache[path], doc.type);
          return;
        }

        var resp = await fetch(path);
        if (!resp.ok) throw new Error('Failed to load (' + resp.status + ')');
        var text = await resp.text();
        state.docs.cache[path] = text;
        renderDocContent(text, doc.type);
      } catch (err) {
        content.innerHTML = '<div class="doc-content-empty" style="color:var(--error);">' +
          'Error loading document: ' + escapeHtml(err.message) + '</div>';
      }
    }

    function scrollDocTo(targetId) {
      var container = $('docContent');
      var el = document.getElementById(targetId);
      if (el && container) {
        container.scrollTop = el.offsetTop - container.offsetTop - 10;
      }
    }

    function renderDocContent(text, type) {
      var content = $('docContent');
      if (type === 'md') {
        content.innerHTML = '<div class="doc-rendered">' + formatContentDoc(text) + '</div>';
      } else if (type === 'ipynb') {
        content.innerHTML = renderNotebook(text);
      }
      content.scrollTop = 0;
    }

    /* ================================================================
       MAPS (Leaflet.js)
       ================================================================ */
    const PHILLY_CENTER = [39.9526, -75.1652]; // City Hall
    const PHILLY_ZOOM = 12;
    let welcomeMapInstance = null;
    let chatMapCounter = 0;

    // Dark-friendly tile layer
    const TILE_URL = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    const TILE_ATTR = '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>';
    // Light tile for city panel context
    const TILE_URL_LIGHT = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';

    function initWelcomeMap() {
      var el = $('welcomeMap');
      if (!el || welcomeMapInstance) return;
      welcomeMapInstance = L.map(el, {
        center: PHILLY_CENTER,
        zoom: PHILLY_ZOOM,
        zoomControl: false,
        attributionControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        touchZoom: false,
      });
      L.tileLayer(TILE_URL, { attribution: TILE_ATTR }).addTo(welcomeMapInstance);
      // Subtle city label
      L.marker(PHILLY_CENTER, {
        icon: L.divIcon({
          className: '',
          html: '<div style="color:#6c8aff;font-size:11px;font-weight:600;text-shadow:0 1px 4px rgba(0,0,0,0.8);white-space:nowrap;">Philadelphia</div>',
          iconSize: [0, 0],
          iconAnchor: [-8, 8],
        }),
      }).addTo(welcomeMapInstance);
    }

    function createChatMap(locations, container) {
      if (!locations || locations.length === 0) return;
      chatMapCounter++;
      var mapId = 'chatMap' + chatMapCounter;

      var wrapper = document.createElement('div');
      wrapper.className = 'chat-map-container';

      var header = document.createElement('div');
      header.className = 'chat-map-header';
      header.innerHTML =
        '<span class="chat-map-title">' +
          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>' +
          locations.length + ' location' + (locations.length !== 1 ? 's' : '') +
        '</span>' +
        '<span class="chat-map-toggle">collapse</span>';

      var mapDiv = document.createElement('div');
      mapDiv.className = 'chat-map';
      mapDiv.id = mapId;

      wrapper.appendChild(header);
      wrapper.appendChild(mapDiv);
      container.appendChild(wrapper);

      // Toggle collapse
      header.onclick = function() {
        var isCollapsed = mapDiv.classList.toggle('collapsed');
        header.querySelector('.chat-map-toggle').textContent = isCollapsed ? 'expand' : 'collapse';
        if (!isCollapsed) map.invalidateSize();
      };

      // Create map after DOM insertion
      var map = L.map(mapId, { zoomControl: true, attributionControl: false });
      L.tileLayer(TILE_URL, { attribution: TILE_ATTR }).addTo(map);

      // Custom marker icon
      var markerIcon = L.divIcon({
        className: '',
        html: '<div style="width:12px;height:12px;background:#6c8aff;border:2px solid #fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>',
        iconSize: [12, 12],
        iconAnchor: [6, 6],
        popupAnchor: [0, -8],
      });

      var bounds = L.latLngBounds();
      for (var i = 0; i < locations.length; i++) {
        var loc = locations[i];
        if (!loc.lat || !loc.lon) continue;
        var popup = '<strong>' + escapeHtml(loc.label || 'Property') + '</strong>';
        if (loc.parcel) popup += '<br>Parcel: ' + escapeHtml(loc.parcel);
        if (loc.owner) popup += '<br>Owner: ' + escapeHtml(loc.owner);
        if (loc.value) popup += '<br>Value: $' + loc.value.toLocaleString();

        L.marker([loc.lat, loc.lon], { icon: markerIcon })
          .bindPopup(popup)
          .addTo(map);
        bounds.extend([loc.lat, loc.lon]);
      }

      if (bounds.isValid()) {
        if (locations.length === 1) {
          map.setView(bounds.getCenter(), 16);
        } else {
          map.fitBounds(bounds, { padding: [30, 30], maxZoom: 16 });
        }
      } else {
        map.setView(PHILLY_CENTER, PHILLY_ZOOM);
      }

      // Scroll map into view
      setTimeout(function() { container.scrollTop = container.scrollHeight; }, 100);
    }

    /* ================================================================
       INIT
       ================================================================ */
    updatePanels();
    loadModels();
    loadUserInfo();
    renderDocList();
    // Init welcome map after a tick (DOM needs to be visible)
    setTimeout(initWelcomeMap, 100);
  </script>

</body>
</html>
